<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>GetUserMedia实例</title>
    <script type="text/javascript" src="js/jsqrcode/grid.js"></script>
    <script type="text/javascript" src="js/jsqrcode/version.js"></script>
    <script type="text/javascript" src="js/jsqrcode/detector.js"></script>
    <script type="text/javascript" src="js/jsqrcode/formatinf.js"></script>
    <script type="text/javascript" src="js/jsqrcode/errorlevel.js"></script>
    <script type="text/javascript" src="js/jsqrcode/bitmat.js"></script>
    <script type="text/javascript" src="js/jsqrcode/datablock.js"></script>
    <script type="text/javascript" src="js/jsqrcode/bmparser.js"></script>
    <script type="text/javascript" src="js/jsqrcode/datamask.js"></script>
    <script type="text/javascript" src="js/jsqrcode/rsdecoder.js"></script>
    <script type="text/javascript" src="js/jsqrcode/gf256poly.js"></script>
    <script type="text/javascript" src="js/jsqrcode/gf256.js"></script>
    <script type="text/javascript" src="js/jsqrcode/decoder.js"></script>
    <script type="text/javascript" src="js/jsqrcode/qrcode.js"></script>
    <script type="text/javascript" src="js/jsqrcode/findpat.js"></script>
    <script type="text/javascript" src="js/jsqrcode/alignpat.js"></script>
    <script type="text/javascript" src="js/jsqrcode/databr.js"></script>
</head>
<body>
<video id="video" width='400' height='400' autoplay></video>
<canvas id='canvas' width='400' height='400'></canvas>
<button onclick="Screenshot()">拍照</button>
<button onclick="switch_cam()">切换</button>
</body>
<script type="text/javascript">
    var video = document.getElementById('video');
    qrcode.callback = function (data)
    {
        if(data === "error decoding QR Code")
            setTimeout(Screenshot(), 1000);
        else
            alert(data);
    };
    var canvas = document.getElementById('canvas');

    if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices)
    {
        console.log("enumerateDevices() not supported.");
    }

    var camera_ids = [];
    var cam_num = 0;
    navigator.mediaDevices.enumerateDevices()
        .then(function (devices)
              {
                  devices.forEach(function (device)
                                  {
                                      if(device.kind.indexOf("video") !== -1)
                                          camera_ids.push(device.deviceId);
                                  });
                  switch_cam();
              })
        .catch(function (err)
               {
                   navigator.mediaDevices.getUserMedia(
                       {
                           audio: false,
                           video: true
                       }).then(stream_func).catch(function (err)
                                                  {
                                                      alert("不支持摄像头");
                                                  });
               });


    function stream_func(stream)
    {
        video.src = window.URL.createObjectURL(stream);
        video.play();
    }

    function switch_cam()
    {
        cam_num = (cam_num + 1) % camera_ids.length;
        navigator.mediaDevices.getUserMedia({
                                                audio: false,
                                                video: {deviceId: {exact: camera_ids[cam_num]}}
                                            }).then(stream_func).catch(function (err)
                                                                       {
                                                                           alert("不支持此摄像头");
                                                                       });
        alert("use camera" + cam_num + ":" + camera_ids[cam_num]);

    }

    function Screenshot()
    {
        canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth * 0.5, video.videoHeight * 0.5);
        var imgData = canvas.toDataURL("image/png");
        qrcode.decode(imgData);
    }
</script>
<html>